<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="author" content="Michael Kearney &amp; Warren P. Porter" />

<meta name="date" content="2016-01-13" />

<title>Underlying theory and equations of the NicheMapR microclimate model</title>




<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0A%7D%0Apre%20%7B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>



<div id="header">
<h1 class="title">Underlying theory and equations of the NicheMapR microclimate model</h1>
<h4 class="author"><em>Michael Kearney &amp; Warren P. Porter</em></h4>
<h4 class="date"><em>2016-01-13</em></h4>
</div>


<center>
<strong>Appendix 1. From “Kearney and Porter (2016). NicheMapR - an R package for biophysical modelling: the microclimate model. in prep”</strong>
</center>
<p> </p>
<center>
Michael R. Kearney<span class="math inline">\(^1\)</span> and Warren P. Porter<span class="math inline">\(^2\)</span><br />
<span class="math inline">\(^1\)</span>School of BioSciences, The University of Melbourne, Parkville, VIC 3010, Australia<br />
<span class="math inline">\(^2\)</span>Department of Zoology, The University of Wisconsin, Madison WI 53706, USA
</center>
<div id="solar-radiation-calculations" class="section level2">
<h2>Solar radiation calculations</h2>
<p>Solar radiation has a dominating effect on the available microclimates across the earth. The total solar irradiance (W m<span class="math inline">\(^{-2}\)</span>) reaching the earth at a given location depends on the radiation reaching the outer edge of the atmosphere at the location of interest (extra-terrestrial radiation – affected by the earth’s orbit, time of year and day, and location on the earth); the effect of the atmosphere as the radiation travels through it to the ground (terrestrial radiation – affected by attenuation due to Raleigh scattering, aerosols, water vapour, ozone and cloud); the terrain (vegetation shade, hill-shade, slope, aspect). The SOLRAD subroutine used in the NicheMapR microclimate model for calculating clear sky solar radiation is based on McCullough and Porter (1971) with modifications to incorporate skylight before sunrise and after sunset (Rozenberg 1966, p. 19) and to include the effects of sloping surfaces and hill-shade.</p>
<div id="extra-terrestrial-radiation" class="section level3">
<h3>Extra-terrestrial Radiation</h3>
<p>The total solar irradiance reaching an imaginary plane perpendicular to the sun’s rays at the outer edge of the atmosphere is obtained by integrating across all wavelengths of radiation emitted by the sun (290 to 4000 nm) after correcting for the distance of the earth from the sun and for the angle at which the sun is shining on that plane. Thus, the wavelength-specific irradiance reaching this plane is I_(0,λ)=S_λ 〖(a/r)〗^2 cos Z where S_λ is solar spectral irradiance reaching a plane perpendicular to the incoming radiation at one astronomical unit from the sun (Fig. 2, data stored internally in SOLRAD), a is the length of the long (semi-major) axis of the earth’s elliptical orbit around the sun, r is the distance between the earth and the sun and Z is the angle between the sun’s rays and a line extending perpendicular to the imaginary plane (so no direct radiation is received by this plane if Z &gt; 90°, but see below for twilight conditions).</p>
<p>The factor 〖(a/r)〗^2 is approximated in the model as 1+2ε cos(ωd) where ω=2π/365, ε is the eccentricity of the earth’s orbit (default value of 0.01675) and d is the day of the year (1-365). From the astronomical triangle, the term cosa〖Z=cos φ cosa〖δ cosa〖h+sina〖φ sinaδ 〗 〗 〗 〗, where φ is the latitude, δ is the solar declination and h is the solar hour angle. The solar declination δ=asina(0.39784993 sin ζ) where the ecliptic longitude of the earth in its orbit ζ = ω(d-80)+2ε[sina(ωd)-sina(ω80) ]. The hour angle h = 15(t¬d – t¬sn) degrees, with t¬d the local standard time of day and tsn the local standard time of true solar noon. The value of tsn is calculated by adding/subtracting 4 min for each degree of longitude west/east of the reference longitude for the local time zone. The hour angle at sunset H_+=arccosa[-tana〖δ tana〖φ]〗 〗 while the hour angle at sunrise H_-=-H_+. In the polar zones, where the (absolute) latitude φ&gt;66°30’, there may be no sunrise/sunset but rather a long day (H+ = π) or a long night (H+ = 0).</p>
</div>
<div id="terrestrial-radiation" class="section level3">
<h3>Terrestrial Radiation</h3>
<p>Solar radiation reaching the earth, i.e. terrestrial radiation, varies from extra-terrestrial radiation because of scattering, reflection and absorption of radiation by the atmosphere. It may thus include a direct I_λ and a scattered component D_λ (skylight or sky radiation), where global terrestrial radiation 〖G_λ 〖=I〗_λ+D〗_λ. The total radiant energy from the sun G is obtained by integrating across all emitted wavelengths, thus G = I + D. If the zenith angle Z is between 170 and 88°, twilight conditions are assumed and G = D = 10(41.34615384-0.423076923 Z)*0.00146 based on the regression in (Rozenberg 1966, p. 19). Otherwise, G is computed by calculating monochromatic irradiance for the direct and diffuse components and then integrating across all wavelengths using the trapezoidal rule.</p>
</div>
<div id="direct-component-of-terrestrial-radiation" class="section level3">
<h3>Direct Component of Terrestrial Radiation</h3>
<p>The direct, horizontal plane component of terrestrial solar radiation is calculated as I_λ=S_λ 〖(a/r)〗^2 cos Z_a expa[-m(Z_a)(_λ^ )τ(h)] where the apparent zenith angle Za is the angle between the beams of direct radiation and the local zenith direction (i.e. vertical) at the surface of the earth, h is the elevation above sea level at which Iλ is to be evaluated, m(Za) is the relative optical air mass, and (_λ^ )τ(h) is the total vertical monochromatic extinction coefficient at elevation h. The term m(Z_a)(_λ^ )τ(h) represents the “total monochromatic extinction coefficient” and is often abbreviated as (_λ^ )τ(Z_a) . Atmospheric refraction means that, for large values of the true zenith angle Z (≥ 88°), the apparent zenith angle Za will differ by a factor R = 16+(Za-88)*10 minutes of an arc. The term m(Za) = 〖[cosa〖Z_a 〗+0.025 expa〖(-11 cosa〖Z_a)]〗 〗〗^(-1). Variation in m(Za) with altitude is ignored as it is negligible up to at least 6 km above sea level.</p>
<p>The total vertical monochromatic extinction depends on Rayleigh scattering (due to molecules, especially oxygen and nitrogen) (_λ^ )τ_R , scattering due to aerosols (dust, water droplets, etc.) (_λ^ )τ_A , and absorption due to ozone (_λ^ )τ_O and water vapour (_λ^ )τ_W , thus (_λ^ )τ(h)=(_λ^ )τ_R (h)+(_λ^ )τ_A (h)+(_λ^ )τ_O (h)+(_λ^ )τ_W (h). The separate extinction factors are first obtained for sea level and then adjusted for elevation h. Wavelength-specific sea level Rayleigh and ozone optical thicknesses are taken from Elterman (1968, 1970) for atmospheric pressure P = 1013 mb, a sea level meteorological range MR0 (visibility at 0.55 μ) of 25 km and a total atmospheric ozone content X of 0.34 cm NTP (normal temperature and pressure; T = 18 °C and P = 1013 mb) (Fig. 3a,b). Rayleigh optical thickness is subsequently adjusted by the ratio of the barometric pressure to the reference pressure. Wavelength-specific sea level optical thickness for 1 cm precipitable water vapour in the air column is taken from Gates and Harrop (1963) (Fig. 3c).</p>
<p>Total atmospheric ozone shows significant seasonal and latitudinal variations, and is assumed to follow the variation in Figure 4 (data from Robinson 1966, p. 114). A correction factor of the ratio of the latitude/season-specific ozone to the reference level (0.34 cm) is thus applied to the elevation-adjusted extinction term for ozone (Fig. 4).</p>
<p>Aerosol attenuation profiles vary significantly with latitude and longitude. The original version of the microclimate model applied data from Elterman (1968, 1970) on wavelength-specific attenuation (Fig. 3d), but this is based on observations in North America which can be strongly divergent from other regions of the globe such as Australia. The microclimate model in NicheMapR now includes the option of using the Global Aerosol Data Set (GADS) (Koepke et al. 1997), <a href="http://www.lrz.de/~uh234an/www/radaer/gads.html" class="uri">http://www.lrz.de/~uh234an/www/radaer/gads.html</a> which is a Fortran program that can produce profiles of aerosol attenuation on a 5°x5° grid of the globe. GADS has been modified to give output for the full spectral profile for a single location (rather than a single wavelength for the all co-ordinates in the database), compiled to be called within the R environment, and included as part of the NicheMapR package. The data for GADS is installed in the folder ‘extdata’ and the Fortran program is called with the function ‘get.gads’ which returns 25 values for optical depths between 250 and 4000 nm for a user specified season (summer or winter) and relative humidity level (8 values ranging from 0-100%). These values can then be splined across the 111 wavelengths required by the microclimate model (see example in function micro_global).</p>
<p>Finally, the extinction factors must be adjusted for elevation h. For (_λ^ )τ_R , (_λ^ )τ_A and (_λ^ )τ_O these adjustments AR, AA and AO, respectively, are made via the following polynomials fitted to the profiles provided by (Elterman 1968):</p>
<p>AR(h)=7.277E-05h3+0.00507293h2-0.12482149h +1.11687469 AA(h)=8.35656E-07h6-6.26384E-05h5+1.86967E-03h4-2.82585E-02h3+2.26739E-01h2-9.25268E-01h+1.71321 AO(h)=1.07573E-06h5-5.14511E-05h4+7.97960E-04h3-4.90904E-03h2 + 2.99258E-03h + 1.00238</p>
<p>The data on which these curves are fitted (Fig. 5) are stored internally in SOLRAD.</p>
<p>In the model, no generic altitudinal correction is made for the effect of precipitable water vapour as its vertical distribution is highly variable, and AW(h) is assumed by default to equal 1 cm for all elevations but can be changed by the user. Using the Gates and Harrop (1963) coefficients, the total monochromatic extinction coefficient for water vapour absorption (_λ^ )τ_W (Z_a,h)=(_λ^ )τ_W √( m〖(Z〗_a 〖) w A〗_W (h))</p>
<p>In summary, the total monochromatic extinction coefficient (_λ^ )τ(Z_a)= m(Z_a ) (_λ^ )τ(h) = m(Z_a )[(P/1013) (_λ^ )τ_R (h) A_R (h)+ (25/(MR_0 )) (_λ^ )τ_A (h) A_A (h)+ (X/0.34) (_λ^ )τ_O (h) A_O (h)]+(_λ^ )τ_W √( m〖(Z〗_a 〖) w A〗_W (h)) . This value is constrained to be no greater than 80 in cases where low sun angles may make m(Z_a ) too large.</p>
</div>
<div id="scattered-component-of-terrestrial-radiation" class="section level3">
<h3>Scattered Component of Terrestrial Radiation</h3>
<p>Scattered radiation D_λ is the solar radiation that is diffusely transmitted by the earth’s atmosphere and depends on the wavelength of the radiation, the solar zenith angle, the optical properties of the terrestrial atmosphere and the reflecting properties of the surface underlying the atmosphere. For wavelengths greater than 360 nanometres, D_λ ((<em>λ^ )τ_R ,Z,A)=I</em>(0,λ) {(γ_l (Z,(_λ^ )τ_R)+ γ_r (Z,(_λ^ )τ_R))/(2(1-A(λ)s ̅((_λ^ )τ_R ))-e^(-(_λ^ )τ_R m(Z_a) ) } where A(λ) is the albedo of the underlying surface and the functions γ_l, γ_r and s ̅ are calculated using the Dave-Warten subroutine (Dave and Warten 1968). In the ultraviolet region, &lt;=360 nanometers, D_λ=S_λ/π (a/r)^2 [F_d (p,Z,λ)+〖F^’〗_d/Q(p,Z,λ)(A(λ))/(1-A(λ)s ̅((_λ^ )τ_R +(_λ^ )τ_O) )] where the functions F_d and 〖F^’〗_d/Q are generated from tables in Dave and Furakawa (1967) and are stored in SOLRAD.</p>
<p>1.5 Slope, aspect and hill-shade effects For sloping surfaces, a correction is made to the zenith angle, Z based on the angle of the slope (SL), the azimuth of the slope (AZSL), and the azimuth of the sun (AZSUN) such that the zenith angle (in radians) for the slope Z_SL =acosa(cosa(Z) cosa(SL)+sina(Z) sina(SL) cosa(〖AZ〗<em>SUN-〖AZ〗<em>SL ) ). In the Southern Hemisphere, the azimuth of the sun 〖AZ〗</em>(SUN,S)=〖acos((sin〗a(φ) sina(90π/180-Z)-sina(δ))/(cosa(φ) cosa(90π/180-Z))) where φ is the latitude and δ is the solar declination. The equivalent formula for the Northern Hemisphere is 〖AZ〗</em>(SUN,N)=〖acos((sina(δ)-sin〗a(φ) sina(90π/180-Z))/(cosa(φ) cosa(90π/180-Z))). This value ranges from 0-180° and is thus subtracted from 360° to obtain afternoon angles.</p>
<p>Local terrain may also obscure direct and diffuse radiation by increasing the horizon angle and thus causing ‘hill-shade’ (Dozier et al. 1981). Horizon angles in 24 directions can be entered into NicheMapR and, when the altitude of the sun is less than the horizon angle in that direction, direct radiation is set to zero. The ‘r.horizon’ function (<a href="https://grass.osgeo.org/grass70/manuals/r.horizon.html" class="uri">https://grass.osgeo.org/grass70/manuals/r.horizon.html</a>) of the GIS package GRASS (Neteler et al. 2012) can be used to compute horizon angles from a DEM.</p>
</div>
<div id="total-solar-radiation-reaching-a-surface" class="section level3">
<h3>Total solar radiation reaching a surface</h3>
<p>The total or ‘global’ solar radiation finally reaching the earth’s surface can now be summarised as Q_solar=G= ∫_0^∞▒〖G_λ dλ=∫_0^∞▒〖〖(I〗<em>λ+D_λ)dλ=I+D〗〗 and depends on the solar zenith angle, the elevation (atmospheric pressure), the albedo of the underlying surface A and the optical properties of the atmosphere. In the NicheMapR microclimate model, it is summed over 11 wavelengths from 0.290 to 4 μ. Adjustments for cloud cover are made according to the Angstrom formula (formula 5.33 on P. 177 of Linacre 1992) Q</em>(solar,cld)=Q_solar (0.36+0.64(1-P_cld)/100) where Pcld is the percentage cloud cover.</p>
</div>
</div>
<div id="longwave-radiation" class="section level2">
<h2>Longwave radiation</h2>
<p>Longwave radiation is a major route of heat exchange in terrestrial environments. All objects in a habitat emit longwave radiation at a rate proportional to the 4th power of their temperature, Q_IR=σεT^4 where σ is the Stefan Boltzman constant (W m−2 K−4), ε is the emissivity and T is the object’s temperature in Kelvin. The heat budget at the ground surface depends in part on the longwave radiation received from the sky and surrounding objects (e.g. hills and shade from vegetation) as well as the longwave radiation it emits. The following equations are used for computing infra-red radiation exchange in the NicheMapR microclimate model.</p>
<p>For longwave radiation from clear skies, ARAD, the sky emissivity is approximated as ε_SKY=1.72(e_A/T_A )^(1/7) (Campbell Gaylson S. and Norman 1998, eqn 10.10), where TA is the shaded air temperature (at reference height – 1.2 m) in Kelvin and eA is the vapour pressure of the air in kilopascals (see section 1.5). Thus, given a percentage cloud clover CLD, A_RAD=σ〖ε_SKY (T_A+273)〗^4 (1-CLD/100). Cloud CRAD longwave radiation are approximated from TA assuming an emissivity of 1, thus C_RAD=σ〖ε_CLD (T_A+273)〗^4 CLD/100 and the total radiation from the sky, given a percentage shade from vegetation or other objects SHD, Q_(IR,SKY)=〖〖(A〗_RAD+C〗<em>RAD)(1-SHD/100). Similarly, assuming objects casting shade are radiating at shaded air temperature, total infra-red radiation from shading Q</em>(IR,VEG)=C_RAD SHD/100.</p>
<p>Given a set of n horizon angles in degrees HORI, the view factor from ground to sky not obscured by hills VIEWF=1-∑<em>(i=1)^n▒〖sina〖(π/180 HORI(i))〗/n〗. Again assuming that hills radiate at shaded air temperature, total radiation from hill-shade Q</em>(IR,HILL)=σ〖ε_HILL (T_A+273)〗^4 (1-VIEWF).</p>
<p>Finally, given a computed ground surface temperature Tsurf, and assuming shaded ground radiates at shaded air temperature, radiation emitted from the ground Q_(IR,GND)=σ〖ε_GND (T_surf+273)〗^4 (1-SHD/100)+C_RAD (SHD/100).</p>
<p>The net longwave radiation gain for the substrate heat budget is therefore Q_IR=〖(Q〗<em>(IR,SKY) 〖+Q〗</em>(IR,VEG))VIEWF+Q_(IR,HILL) (1-VIEWF)-Q_(IR,GND) and the effective ‘sky temperature’, an output of the microclimate model, 〖〖T_SKY=[((Q〗<em>(IR,SKY) 〖+Q〗</em>(IR,VEG))VIEWF+Q_(IR,HILL) (1-VIEWF))/σ]〗^(1/4) (assuming an emissivity of 1).</p>
</div>
<div id="hourly-interpolation-of-weather-data" class="section level2">
<h2>Hourly interpolation of weather data</h2>
<p>The weather station data inputs – air temperature, relative humidity, wind speed and cloud cover – are maximum and minimum values for the day and must be converted to hourly profiles. The subroutines VSINE and SINEC do this based on the user inputs of when the daily minima and maxima occur relative to sunrise and solar noon and the timings of sunrise, sunset and solar noon as computed by SOLRAD.</p>
<p>VSINE works with relative humidity, wind speed and cloud cover. It first assumes the midnight value is the average of the given minimum and maximum, and computes three slopes: a slope from the midnight point to the sunrise maximum (cloud cover, relative humidity) or minimum (wind speed) value, a slope from the sunrise value to the midday minimum (cloud cover, relative humidity) or maximum (wind speed) value, and slope from the midday value back to the assumed midnight value. The model then uses these slopes to compute the values on the hour through the entire day. Note, however, that if the model is running for every day of the year (and is not doing the first day of the simulation) it uses the value for the last hour of the previous day as the initial value for midnight on the current day. Otherwise, it uses the average of the minimum and maximum value as the starting point. The result is a day length-specific linear interpolation.</p>
<p>SINEC uses a slightly more sophisticated approach to create hourly profiles of air temperature to capture the initial rapid decline in air temperature from its maximum prior to sunset, and the more gradual decline that occurs through the nighttime. The temperature at sunrise TSR is assumed to be the minimum temperature, while the temperature at sunset T_ss=AZ_s+T_(min )+A, where A is the average of the minimum and maximum air temperature and Z_s=sina〖(360(t_ss-t_ref)/(2(t_(T_max )-t_sr ))/57.29577)〗, where tss and tsr are the times (in US military time) of sunrise and sunset, respectively, t_(T_max ) is the time of the maximum air temperature and t_ref=〖(t〗_(T_max )-t_sr)/2+t_sr. From midnight to sunrise, if all days of the year are being run (and it is not the first day), air temperature is assumed to change linearly from the last temperature of the previous day to the minimum temperature at TSR. Otherwise, air temperature changes with an exponential decay as T_air= 〖(T〗<em>SS-T_SR)/expa(E)+T_SR where E=τ[(2400-T_SS)+t] and τ=3/((2400.-T_SS)+T_SR). Similarly, an exponential decay occurs from the temperature at sunset towards midnight temperature, where the latter is assumed to be either the minimum temperature of the next day if all days or the year are being run, or the temperature at sunrise. Otherwise, if time is between sunrise and sunset, the air temperature is assumed to follow a sine wave T_air=AZ+T_min+A where Z=sina〖(360(t-t_ref)/(2(t</em>(T_max )-t_sr ))/57.29577)〗.</p>
</div>
<div id="vertical-air-temperature-and-wind-speed-profiles" class="section level2">
<h2>Vertical air temperature and wind speed profiles</h2>
<p>Air temperature and wind speed vary with height above the ground as a function of the air temperature and wind speed at the reference height, the surface temperature, and the presence and spacing of objects on the surface (surface roughness). In the NicheMapR microclimate model, the MICRO subroutine computes a single unsegmented wind velocity u and temperature profile based on the user-specified roughness height z0 and reference height z while MICROSEGMT computes a three segment velocity and temperature profile based on user-specified, experimentally determined values for roughness heights z0,1 and z0,2 at two segment heights z1 and z2.</p>
<p>The MICRO subroutine first checks for free convection (lapse) conditions … The wind speed at the new local height u_loc=2.5u^* lna〖(z_loc 〗/z_0+1), where the friction velocity u^*=0.4u 〖/ ln〗a〖(z〗/z_0+1), with u the wind speed at reference height and 0.4 being the von Karman constant.</p>
<p>Given the reference air temperature Tref and the current estimate of the substrate surface temperature Tsub, the fictitious temperature at the roughness height T_(z_0 )=(T_ref 〖St〗_b+T_sub 〖St〗_s)/(〖St〗_b+〖St〗_s), with the sublayer Stanton number 〖St〗_s=0.62/ 〖((z_0 u^*)/12)〗^0.45 and the bulk Stanton number 〖St〗<em>b=0.64 〖/ ln〗a〖(z〗/z_0+1). Then the air temperature at a new local height Tloc can then be computed as T_loc=T</em>(z_0 )+(T_ref-T_(z_0 ))lna〖(z_loc 〗/z_0+1).</p>
<p>If experimental data are specified for the three segment velocity profile, i.e. z1, z2, z0,1 and z0,2 are non-zero, then MICROSEGMT is called instead of MICRO. The computations are similar except that now 〖u_1〗^<em>=0.4u_1 〖/ ln〗a〖(z_1 〗/z_0,1+1), 〖u_2〗^</em>=0.4u_2 〖/ ln〗a〖(z_2 〗/z_0+1), with u_1=(u^<em>/0.4)〖 ln〗a〖(z_1 〗/z_0,1+1) and u_2=(〖u_1〗^</em>/0.4)〖 ln〗a〖(z_2 〗/z_0,2+1). Then 〖St〗_s=0.62/ 〖((z_0 〖u_2〗^<em>)/12)〗^0.45 and 〖St〗<em>b=0.64 〖/ ln〗a〖(z_2 〗/z_0+1). The wind speed at height i is now u(i)=2.5〖u_s〗^* lna〖(z_i 〗/z</em>(0,s)+1), where if z1  zi, 〖u_s〗^</em>= u^* and z0,s = z0,1 whereas if, z1 &gt; zi then if z2  zi, 〖u_s〗^<em>= 〖u_1〗^</em> and z0,s = z0,2 but if z2 &gt; zi, 〖u_s〗^<em>= 〖u_2〗^</em> and z0,s = z0. The air temperature profile is as specified above for subroutine MICRO, but with the modified values of the Stanton numbers Sts and Stb.</p>
<p>Finally, convective heat transfer at the surface is computed as Q_conv=0.08472/T_ave (T_ref-T_sub)u^* 〖(St〗_b/(1+〖St〗_b/〖St〗_bs)) where Tave is the average of the reference and substrate temperatures in kelvin.</p>
</div>
<div id="hydric-and-thermal-properties-of-air-and-surface-evaporation" class="section level2">
<h2>Hydric and thermal properties of air, and surface evaporation</h2>
<p>Subroutines DRYAIR, WETAIR, HUMID and EVAP, together with function VAPPRS, compute the hydric and thermal properties of air, and the implication for evaporation from the surface. DRYAIR, WETAIR and VAPPRS are now available as R functions in the NicheMapR package and are described in detail in the technical manual “Properties of Air” (Tracy et al. 2016, Tracy et al. 1980) which is now available as a vignette in NicheMapR.</p>
<p>DRYAIR computes atmospheric pressure P=〖101325(1-(0.0065A/288)) 〗^(1/0.190284) where A is altitude (m), together with the air density ρ_air=101325/(287.04(T_air+273.15)) where Tair is the air temperature (C), the dynamic viscosity v_dyn=1.8325×〖10〗^(-5) ((296.16+C)/(ρ_air+273.15+120)))*((〖(T_air+273.15)/296.16)〗^1.5, the kinematic viscosity v_kin= v_dyn/ρ_air, diffusivity of water vapour in air α=2.26×〖10〗^(-5) (〖((T_air+273.15)/ 273.15)〗^1.81)( 1×〖10〗^5/ P), the thermal conductivity of air k_air=0.02425+(7.038×〖10〗^(-5) T_air), and the latent heat of vapourisation of water ∆H_vap=2.5012〖10〗<sup>6-2.3787×〖10〗</sup>3 T_air.</p>
<p>Function VAPPRS computes the saturation water vapour pressure for a given Tair as e<sup><em>=〖10〗^(a(T_o/T_air -1)+b log_10a(T_o/T_air )-c(〖10〗^((d(1-T_air/T_o )) )-1)+e(〖10〗^((f(T_o/T_air -1)) )-1)+log_10a(P_0 ) ) where Tair is in kelvin, P0=1013.246, T0=373.16 a=-7.90298, b = 5.02808, c=1.3816×〖10〗^(-7), d=11.344, e=8.1328×〖10〗^(-3) and f=-3.49149 when Tair is positive and e^</em>=〖10〗</sup>((T_o/T_air -1)+b log_10a(T_o/T_air )+c(1-T_air/T_o )+log_10a(d) ), where T0=273.16, a=-9.09718, b=3.56654, c=0.876793, and d=6.1071, when Tair is zero or negative. WETAIR uses VAPPRS to compute vapour pressure for the current relative humidity e=e^* RH/100 where RH is relative humidity (%), the vapour density v_d=e^* 0.018016 / (0.998RT_air) where R=8.31434 and Tair is in kelvin, the specific heat c_p=(1004.84 + (r_w 1846.40)) / (1.0 + r_w) where the mixing ratio r_w = ((0.62197(1.0053e)) / (P - 1.0053e)), the density of air ρ_air=0.0034838 P / (0.999T_v) where the virtual temperature T_v=T_air ((1.0 + r_w/ (18.016 / 28.966)) / (1.0 + r_w)) and Tair is in kelvin, and some additional properties of humid air not used in the microclimate model. Further details can be found in Tracy et al. (2016).</p>
<p>HUMID uses DRYAIR and WETAIR to adjust relative humidity from the reference height to the local height. EVAP uses DRYAIR and WETAIR to compute the vapour density at 100% relative humidity and at the current humidity, and then determines evaporation from the surface according to the equation m_evap= P_wet/100 h_d (v_(d,surf) - v_(d,air)), where Pwet is the % of the unit surface area that is acting as a free water surface. The mass transfer coefficient h_d=(h_c/(c_p ρ_air))〖(0.71/0.60)〗^0.666 and the convective heat transfer coefficient h_c=maxa(|Q_conv/(T_loc-T_ref )|,0.5) are both computed in DSUB. Finally, m_evap is converted to energy lost/gained as heat by evaporation/condensation Q_evap=m_evap ∆H_vap where the latent heat of vaporisation is computed as ∆H_vap=〖10〗^3 (2500.8-2.36T_surf+0.0016〖T_surf〗<sup>2-0.00006〖T_surf〗</sup>3) if the surface temperature Tsurf &gt; 0 °C, and ∆H_vap=〖10〗^3 (2834.1-0.29T_surf+0.004〖T_surf〗^2) if Tsurf  0 °C.</p>
</div>
<div id="soil-heat-balance-and-soil-thermal-properties" class="section level2">
<h2>Soil heat balance and soil thermal properties</h2>
<p>The soil temperature change through depth z and time t is described by the one-dimensional partial differential equation dT/dt=k/ρc (∂^2 T)/(∂z^2 ) (Carslaw and Jaeger 1959) and requires one initial condition and two boundary conditions for its solution. The initial condition (soil temperature profile) is either the mean daily reference air temperature or (when doing daily simulations) the temperature profile at the end of the previous day. The deep soil boundary condition is obtained by assuming it is the mean annual air temperature. The remaining boundary condition at the soil surface is obtained by equating the energy conducted to the soil surface to the net heat transfer to the surface by solar radiation, infrared radiation, convection and evaporation, i.e. an energy balance for the soil surface Q_cond=├ 〖-k〗<em>so ∂T/∂z┤|</em>(z_0 )=Q_solar+Q_IR+Q_conv-Q_evap</p>
<p>This equation is solved by breaking the soil profile into nodes and solving separate ODEs for each using the Adams Predictor-Corrector algorithm with Runge Kutta starting, with the ODE for the surface (dT_(s,1))/dt=(Q_solar+Q_IR+Q_conv-Q_evap)/C_(s,1) and the subsequent ODEs (dT_(s,i))/dt=(K_(s,i-1) (T_(s,i-1)-T_(s,i))+K_(s,i) (T_(s,i+1)-T_(s,i)))/C_(s,i) where for a given node i the heat capacity C_i= ρ_(s,i) c_(s,i) (z_(i+1)-z_(i-1))/2, and K_(s,i)= k_(s,i) (z_(i+1)-z_i) where ks,i is the thermal conductivity. The computation of the terms Qsolar, QIR, Q¬conv and Qevap have been described earlier in this document.</p>
<p>In the NicheMapR microclimate model, 10 soil nodes are specified, including the surface. The spacing is under the control of the user but must be closer near the surface where changes are most rapid, to ensure that the numerical integration is successful. The key soil thermal properties in the equations above are the density ¬s, the specific heat capacity cs and the thermal conductivity ks, all of which may vary with time as a function of soil temperature and moisture, and with depth as a function of geology. The original version of the microclimate model did not permit soil properties to vary with depth or time. In the present version up to 10 different soil properties with depth (i.e. unique properties for each node). The user specifies the conductivity, specific heat capacity, density and water-holding capacity of the mineral components of the different soil layers together with the bulk density and a time-vector for each layer of relative soil moisture values. The overall soil conductivity, specific heat and density values are then adjusted for bulk density and soil moisture and soil temperature, using the methods described in Campbell et al. (1994, equations 8, 9) and Campbell and Norman (Campbell Gaylson S. and Norman 1998, equations 8.13, 8.17, 8.20 and data in tables 8.2 and 9.1) in the subroutine SOILPROPS (Fig. 1) which is called by DSUB and utilises the routines in DRYAIR, WETAIR and VAPPRS. If the soil temperature is between -0.45 and 0.4 °C and there is moisture in the soil, the latent heat of fusion (333.5 J/g) is added to the computation of specific heat.</p>
</div>
<div id="soil-water-balance" class="section level2">
<h2>Soil water balance</h2>
<p>The NicheMapR microclimate model now has the capacity for the user to provide daily inputs for soil moisture levels, or they can be calculated from first principles as a function of rainfall, soil type and transpiration. To calculate the soil water budget, we have integrated Campbell’s (1985) Program 11.1 (henceforth C11.1) for simulating depth-specific soil moisture, water potential and humidity gradients in the presence of vegetation. This model takes the approach of linearising the differential equation for flow in space, and using a Newton-Raphson procedure to solve the non-linear equations through time. The linearisation through space involves representing the soil as a series of capacitors and resistors (see Campbell G. S. 1985 Fig. 8.5). It uses matric potential as the dependent variable (rather than matric flux potential) and hence is most computationally efficient when soil is relatively dry. The model is well described in Campbell (1985) thus here we only provide details specific to the integration with the NicheMapR microclimate model and driving data.</p>
<p>We wrote C11.1 as Fortran subroutine INFIL which is called from the hourly output OSUB (Fig. 1), with the soil temperature computed for a given hour being used to drive the soil moisture calculations. In turn, the calculated soil moisture profile was used in the computation of the next hour’s soil temperatures. The INFIL routine is iterated with a 6 minute step size to increase the accuracy of the solutions (shorter step sizes did not substantially alter the predictions). We assumed the daily rainfall all occurred in the first hour of the day and kept track of water pooling on the surface by the subtracting the amount computed by C11.1 to have infiltrated or evaporated, with a maximum possible pool depth set by the user. If at any stage water was pooled on the surface, we set the first soil node to be saturated, which effected infiltration.</p>
<p>Potential evaporation was computed by simulating evaporation from a completely wet surface using code of the original version of the NicheMapR model. Following Campbell (1985, equation 12.30), this was partitioned among evaporation and transpiration as a function of leaf area index (a user input). The fractional surface wetness for the next hour’s heat budget was set as the ratio of potential to actual evapotranspiration calculated by C11.1.</p>
<p>The microclimate model uses 10 user-specified nodes for computing the heat budget. We added code to C11.1 to insert extra nodes half way between the original 10 nodes, such that a total of 19 nodes were used for soil moisture calculations. The user input variables specific to C11.1 include, for each of these 19 nodes, the Campbell (or Clapp and Hornberger) exponent b, the air entry potential e (J/kg), the hydraulic conductivity Ks (kg s m-3), the bulk density b (kg m-3) and the root density (m m-3) in addition to the leaf area index LAI already mentioned. All other model parameters for C11.1 were fixed at those suggested by Campbell (1985).</p>
</div>
<div id="snow" class="section level2">
<h2>Snow</h2>
<p>The capacity to model the growth and decay of a snowpack, and its influence on substrate temperatures, has been incorporated into the NicheMapR microclimate model by allowing an additional 8 nodes of snow to be added to the 10 substrate nodes, with their thermal properties set to that of ice when snow is present. The snow nodes are at 2.5, 5, 10, 20, 50, 100, 200 and 300cm, with the original 0cm node continuing to act as the surface node and the connection between the 300cm node and the original soil surface able to grow to an arbitrary large extent. As the snow pack grows, subroutine SNOWLAYER (Fig. 1) checks to see whether sufficient snow has accreted or melted to increase or decrease the number of snow nodes in use. Snow is not permitted to be below 2.5 cm depth. Subroutine OSUB contains the formulae for computing snow growth and melt, and calls SNOWLAYER (Fig. 1)</p>
<p>Snow growth is driven by inputted precipitation for each day and the user specified thresholds for the air temperature at which rain becomes snow, and the snow density (either a fixed value or a linear change of density with day of year). All snow for a given day is assumed to fall at midnight, and the user can specify a multiplier to account for under-catch if necessary (Rasmussen et al. 2012). When snow is present, the surface albedo A changes as a function of the age of the snow pack as A=(-9.8740 ln(d_snow)+78.3434)/100 where d¬snow is the days since the last snowfall based on regressions fitted to Fig A-4 of Anderson (2006). Snow thermal conductivity is estimated from Djachkova’s formula following Anderson (2006) k_snow=0.0442e^5.181 ρ_snow.</p>
<p>Snow melt occurs according to the heat load as computed by the heat budget for the substrate (including the snow), as well as melting due to rain. If the mean temperature between a given pair of soil nodes is greater than 0.4 °C, the change in mean temperature between nodes is computed and multiplied by the snow heat capacity (including the heat of fusion), snow density and distance between the nodes to obtain the heat input, and then divided by the heat of fusion to compute the mass of snow melted. Rain-melt is simulated following Anderson (2006) by multiplying the product of the rainfall and mean air temperature for the day by a rain melt factor (default value 0.0125) whenever rain falls at air temperatures above the snow threshold.</p>
</div>
<div id="references" class="section level2">
<h2>References</h2>
<p>Anderson E. 2006. Snow Accumulation and Ablation Model – SNOW-17</p>
<p>Campbell GS. 1985. Soil Physics with Basic: Transport Models for Soil-Plant Systems. Amsterdam: Elsevier.</p>
<p>Campbell GS, Jungbauer JDJ, Bidlake WR, Hungerford RD. 1994. Predicting the effect of temperature on soil thermal conductivity. Soil Science 158:307-313.</p>
<p>Campbell GS, Norman JM. 1998. Environmental Biophysics. Springer.</p>
<p>Carslaw HS, Jaeger JC. 1959. Conduction of heat in solids. Oxford University Press.</p>
<p>Dave JV, Furakawa PM. 1967. Scattered radiation in the ozone absorption bands at selected levels of a terrestrial Rayleigh atmosphere. Americal Meteorological Society.</p>
<p>Dave JV, Warten RM. 1968. Program for computing the Stokes parameters of the radiation emerging from a plane-parallel, non-absorbing, Rayleigh atmosphere. Palo Alto, California: IBM Scientific Center. Report no.</p>
<p>Dozier J, Bruno J, Downey P. 1981. A faster solution to the horizon problem. Computers and Geosciences 7:145-151.</p>
<p>Elterman L. 1968. UV, visible and IR attenuation for altitudes to 59 km. Bedford, Mass.: U. S. Airforce Cambridge Research Laboratory. Report no.</p>
<p>—. 1970. Vertical-attenuation model with eight surface meteorological ranges 2 to 13 kilometers. Bedford, Mass.: U. S. Airforce Cambridge Research Laboratory. Report no.</p>
<p>Gates DM, Harrop WJ. 1963. Infrared transmission of the atmosphere to solar radiation. Applied Optics 2:887-898.</p>
<p>Koepke P, Hess M, Schult I, Shettle EP. 1997. Global Aerosol Data Set. Hamburg: Max-Planck-Institut für Meteorologie. Report no.</p>
<p>Linacre E. 1992. Climate data and resources. Routledge.</p>
<p>McCullough EC, Porter WP. 1971. Computing clear day solar radiation spectra for the terrestrial ecological environment. Ecology 52:1008-1015.</p>
<p>Neteler M, Bowman MH, Landa M, Metz M. 2012. GRASS GIS: A multi-purpose open source GIS. Environmental Modelling &amp; Software 31:124–113.</p>
<p>Rasmussen R, et al. 2012. How Well Are We Measuring Snow: The NOAA/FAA/NCAR Winter Precipitation Test Bed. Bulletin of the American Meteorological Society 93:811-829.</p>
<p>Robinson N. 1966. Solar Radiation. Elsevier.</p>
<p>Rozenberg GV. 1966. Twilight: A Study in Atmospheric Optics. Plenum Press.</p>
<p>Tracy CR, Welch WR, Pinshow B, Kearney MR, Porter WP. 2016. Properties of air: A manual for use in biophysical ecology. Madison: The University of Wisconsin. Report no.</p>
<p>Tracy CR, Welch WR, Porter WP. 1980. Properties of air: A manual for use in biophysical ecology. Madison: The University of Wisconsin. Report no.</p>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
